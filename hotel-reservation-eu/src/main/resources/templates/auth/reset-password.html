<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<head>
    <title>重置密码</title>
</head>
<body>
    <main th:fragment="content" class="auth-container">
        <div class="auth-card">
            <div class="card">
                <div class="card-header bg-white text-center py-4">
                    <h2 class="mb-0">
                        <i class="fas fa-lock text-success me-2"></i>
                        重置密码
                    </h2>
                    <p class="text-muted mb-0">请输入您的新密码</p>
                </div>
                
                <div class="card-body p-4">
                    <!-- 错误消息 -->
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <!-- 重置密码表单 -->
                    <form th:action="@{/auth/reset-password}" method="post" th:object="${resetPasswordRequest}" id="resetPasswordForm">
                        <input type="hidden" th:field="*{token}">
                        
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">
                                <i class="fas fa-lock me-2"></i>新密码
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control form-control-lg" 
                                       id="newPassword" 
                                       th:field="*{newPassword}"
                                       placeholder="请输入新密码（至少6个字符）"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div th:if="${#fields.hasErrors('newPassword')}" class="text-danger mt-2">
                                <small th:errors="*{newPassword}"></small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">
                                <i class="fas fa-lock me-2"></i>确认新密码
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control form-control-lg" 
                                       id="confirmPassword" 
                                       th:field="*{confirmPassword}"
                                       placeholder="请再次输入新密码"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <small id="passwordMatch"></small>
                            </div>
                            <div th:if="${#fields.hasErrors('confirmPassword')}" class="text-danger mt-2">
                                <small th:errors="*{confirmPassword}"></small>
                            </div>
                        </div>
                        
                        <!-- 密码强度指示器 -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">密码强度：</small>
                                <span id="passwordStrengthText" class="badge">弱</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">
                                建议：至少8个字符，包含大小写字母、数字和特殊字符
                            </small>
                        </div>
                        
                        <div class="d-grid mb-4">
                            <button type="submit" class="btn btn-success btn-lg" id="resetPasswordBtn">
                                <i class="fas fa-check me-2"></i>重置密码
                            </button>
                        </div>
                    </form>
                    
                    <!-- 安全提示 -->
                    <div class="alert alert-warning">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>安全提示：</strong>
                        <ul class="mb-0 mt-2">
                            <li>请选择一个强密码</li>
                            <li>不要使用与其他网站相同的密码</li>
                            <li>重置后请立即登录确认</li>
                        </ul>
                    </div>
                    
                    <!-- 链接 -->
                    <div class="text-center">
                        <p class="mb-0">
                            <a th:href="@{/auth/login}" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>返回登录页面
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页面特定脚本 -->
    <th:block th:fragment="page-scripts">
        <script>
            $(document).ready(function() {
                // 密码显示/隐藏切换
                $('#toggleNewPassword').click(function() {
                    togglePasswordVisibility('#newPassword', this);
                });
                
                $('#toggleConfirmPassword').click(function() {
                    togglePasswordVisibility('#confirmPassword', this);
                });
                
                function togglePasswordVisibility(fieldSelector, button) {
                    const passwordField = $(fieldSelector);
                    const icon = $(button).find('i');
                    
                    if (passwordField.attr('type') === 'password') {
                        passwordField.attr('type', 'text');
                        icon.removeClass('fa-eye').addClass('fa-eye-slash');
                    } else {
                        passwordField.attr('type', 'password');
                        icon.removeClass('fa-eye-slash').addClass('fa-eye');
                    }
                }
                
                // 密码强度检测
                $('#newPassword').on('input', function() {
                    const password = $(this).val();
                    const strength = calculatePasswordStrength(password);
                    updatePasswordStrengthUI(strength);
                });
                
                function calculatePasswordStrength(password) {
                    let score = 0;
                    if (password.length >= 8) score += 25;
                    if (password.length >= 12) score += 25;
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 25;
                    if (/\d/.test(password)) score += 15;
                    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score += 10;
                    return Math.min(score, 100);
                }
                
                function updatePasswordStrengthUI(strength) {
                    const strengthBar = $('#passwordStrengthBar');
                    const strengthText = $('#passwordStrengthText');
                    
                    strengthBar.css('width', strength + '%');
                    
                    if (strength < 30) {
                        strengthBar.removeClass().addClass('progress-bar bg-danger');
                        strengthText.removeClass().addClass('badge bg-danger').text('弱');
                    } else if (strength < 60) {
                        strengthBar.removeClass().addClass('progress-bar bg-warning');
                        strengthText.removeClass().addClass('badge bg-warning').text('中等');
                    } else if (strength < 80) {
                        strengthBar.removeClass().addClass('progress-bar bg-info');
                        strengthText.removeClass().addClass('badge bg-info').text('良好');
                    } else {
                        strengthBar.removeClass().addClass('progress-bar bg-success');
                        strengthText.removeClass().addClass('badge bg-success').text('强');
                    }
                }
                
                // 密码匹配验证
                $('#confirmPassword').on('input', function() {
                    const newPassword = $('#newPassword').val();
                    const confirmPassword = $(this).val();
                    const feedback = $('#passwordMatch');
                    
                    if (confirmPassword.length > 0) {
                        if (newPassword === confirmPassword) {
                            feedback.text('✓ 密码匹配').removeClass('text-danger').addClass('text-success');
                        } else {
                            feedback.text('✗ 密码不匹配').removeClass('text-success').addClass('text-danger');
                        }
                    } else {
                        feedback.text('');
                    }
                });
                
                // 表单提交处理
                $('#resetPasswordForm').submit(function(e) {
                    const newPassword = $('#newPassword').val();
                    const confirmPassword = $('#confirmPassword').val();
                    
                    if (newPassword !== confirmPassword) {
                        e.preventDefault();
                        alert('新密码和确认密码不匹配！');
                        return false;
                    }
                    
                    if (newPassword.length < 6) {
                        e.preventDefault();
                        alert('密码长度至少需要6个字符！');
                        return false;
                    }
                    
                    const resetPasswordBtn = $('#resetPasswordBtn');
                    const originalText = resetPasswordBtn.html();
                    showLoading(resetPasswordBtn[0]);
                    
                    // 防止多次提交
                    setTimeout(function() {
                        if (resetPasswordBtn.is(':disabled')) {
                            hideLoading(resetPasswordBtn[0], originalText);
                        }
                    }, 3000);
                });
            });
        </script>
    </th:block>
</body>
</html> 